name: Monitor Upstream Release and Build

on:
  workflow_dispatch:        # 手動実行用
  schedule:
    - cron: '0 * * * *'     # 1時間ごとにチェック

permissions:
  contents: write           # リリース作成とタグ打ちに必要

jobs:
  check_build_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. オリジナルの最新リリースを確認
      - name: Check for new release
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          UPSTREAM_TAG=$(gh api repos/mostafaalagamy/Metrolist/releases/latest --jq .tag_name)
          echo "Upstream latest tag: $UPSTREAM_TAG"
          
          if git rev-parse "$UPSTREAM_TAG" >/dev/null 2>&1; then
            echo "Tag $UPSTREAM_TAG already exists. Skipping build."
            echo "trigger_build=false" >> $GITHUB_OUTPUT
          else
            echo "New version found: $UPSTREAM_TAG. Proceeding with build."
            echo "trigger_build=true" >> $GITHUB_OUTPUT
            echo "release_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          fi

      # 2. コードの取得
      - name: Fetch Upstream Source
        if: steps.check.outputs.trigger_build == 'true'
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          
          # カスタムアイコン退避
          cp icon.png /tmp/custom_icon.png || echo "No custom icon found."

          git remote add upstream https://github.com/mostafaalagamy/Metrolist.git
          git fetch upstream --tags
          git checkout -b build-${{ steps.check.outputs.release_tag }} refs/tags/${{ steps.check.outputs.release_tag }}

          # カスタムアイコン復元
          if [ -f /tmp/custom_icon.png ]; then
            mv /tmp/custom_icon.png icon.png
          fi

      # 3. Java 21 セットアップ
      - name: Set up JDK 21
        if: steps.check.outputs.trigger_build == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # Gradleセットアップ
      - name: Setup Gradle
        if: steps.check.outputs.trigger_build == 'true'
        uses: gradle/actions/setup-gradle@v4

      # 4. 【新機能】丸アイコン自動生成 (ImageMagick)
      - name: Generate Round Icon
        if: steps.check.outputs.trigger_build == 'true'
        run: |
          if [ -f icon.png ]; then
            echo "Generating round icon from icon.png..."
            # ImageMagickを使って中心を円形に切り抜く
            convert icon.png -alpha on \( +clone -channel a -evaluate multiply 0 +channel -fill white -draw "circle $(identify -format "%[fx:w/2],%[fx:h/2] %[fx:w],%[fx:h/2]" icon.png)" \) -compose DstIn -composite icon_round.png
            echo "icon_round.png created."
          else
            echo "icon.png not found, skipping generation."
          fi

      # 5. 【改造】Metrolist Neo化 & アイコン置換 (JS版)
      - name: Modify for Clone (JavaScript)
        if: steps.check.outputs.trigger_build == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // --- アイコン強制置換 ---
            if (fs.existsSync('icon.png')) {
                console.log("Custom icon found. Replacing...");
                const resPath = 'app/src/main/res';
                
                if (fs.existsSync(resPath)) {
                    const dirs = fs.readdirSync(resPath).filter(name => name.startsWith('mipmap-'));
                    dirs.forEach(dirName => {
                        const dirPath = path.join(resPath, dirName);
                        
                        // 1. Adaptive Icon (XML) を削除 (これをしないと画像が変わらない)
                        if (dirName.includes('anydpi')) {
                             fs.readdirSync(dirPath).forEach(file => {
                                 if (file.startsWith('ic_launcher')) fs.unlinkSync(path.join(dirPath, file));
                             });
                             return; 
                        }

                        // 2. 通常アイコン (ic_launcher) の置換
                        ['.webp', '.png', '.xml'].forEach(ext => {
                            const f = path.join(dirPath, 'ic_launcher' + ext);
                            if (fs.existsSync(f)) fs.unlinkSync(f);
                        });
                        fs.copyFileSync('icon.png', path.join(dirPath, 'ic_launcher.png'));

                        // 3. 丸アイコン (ic_launcher_round) の置換
                        // 自動生成した icon_round.png があればそれを使う
                        const roundSource = fs.existsSync('icon_round.png') ? 'icon_round.png' : 'icon.png';
                        ['.webp', '.png', '.xml'].forEach(ext => {
                            const f = path.join(dirPath, 'ic_launcher_round' + ext);
                            if (fs.existsSync(f)) fs.unlinkSync(f);
                        });
                        fs.copyFileSync(roundSource, path.join(dirPath, 'ic_launcher_round.png'));
                    });
                    console.log("Icon replacement complete.");
                }
            }
            // ---------------------------

            function walkDir(dir, callback) {
                fs.readdirSync(dir).forEach(f => {
                    let dirPath = path.join(dir, f);
                    if (f === '.git') return; 
                    let isDirectory = fs.statSync(dirPath).isDirectory();
                    isDirectory ? walkDir(dirPath, callback) : callback(path.join(dir, f));
                });
            }

            // ダミーjson作成
            const dummyJson = {
              "project_info": { "project_number": "000000000000", "project_id": "dummy", "storage_bucket": "dummy" },
              "client": [{
                "client_info": { "mobilesdk_app_id": "1:000000000000:android:000000", "android_client_info": { "package_name": "com.metrolist.clone" } },
                "api_key": [{ "current_key": "dummy" }]
              }]
            };
            fs.writeFileSync('app/google-services.json', JSON.stringify(dummyJson));

            // ファイル書き換え
            walkDir('.', function(filePath) {
                // build.gradle.kts
                if (filePath.endsWith('build.gradle.kts')) {
                    let content = fs.readFileSync(filePath, 'utf8');
                    let original = content;
                    
                    // ID変更
                    content = content.replace(/applicationId\s*=\s*"[^"]*"/g, 'applicationId = "com.metrolist.clone"');
                    // Plugin無効化
                    content = content.replace(/(.*alias\(libs\.plugins\.google\.services\).*)/g, '// $1');
                    content = content.replace(/(.*id\("com\.google\.gms\.google-services"\).*)/g, '// $1');

                    if (content !== original) fs.writeFileSync(filePath, content, 'utf8');
                }
                
                // strings.xml (アプリ名の変更)
                // values, values-ja, values-en などを全て網羅して書き換える
                if (filePath.endsWith('strings.xml')) {
                    let content = fs.readFileSync(filePath, 'utf8');
                    
                    // <string name="app_name">Metrolist</string> を正規表現で探して置換
                    // どんな言語ファイルでも "app_name" というキーがあれば書き換える
                    const appNameRegex = /<string name="app_name">([^<]*)<\/string>/g;
                    
                    if (appNameRegex.test(content)) {
                        console.log(`Updating app_name in ${filePath}`);
                        content = content.replace(appNameRegex, '<string name="app_name">Metrolist Neo</string>');
                        fs.writeFileSync(filePath, content, 'utf8');
                    }
                }
            });

      - name: Grant execute permission for gradlew
        if: steps.check.outputs.trigger_build == 'true'
        run: chmod +x gradlew

      # 6. ビルド実行
      - name: Build Release APK
        if: steps.check.outputs.trigger_build == 'true'
        run: ./gradlew assembleRelease --no-configuration-cache -x lint -x test --stacktrace
        env:
          GITHUB_EVENT_NAME: pull_request
          LASTFM_API_KEY: "dummy_value"
          LASTFM_SECRET: "dummy_value"

      # 7. APK回収
      - name: Collect APKs
        if: steps.check.outputs.trigger_build == 'true'
        run: |
          mkdir -p output_apks
          find app/build/outputs/apk -name "*.apk" -type f -exec cp {} output_apks/ \;

      # 8. 署名
      - name: Sign APK
        if: steps.check.outputs.trigger_build == 'true'
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: output_apks
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"

      # 9. リリース作成
      - name: Create Release
        if: steps.check.outputs.trigger_build == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.check.outputs.release_tag }}
          name: Metrolist Neo ${{ steps.check.outputs.release_tag }}
          body: |
            Automated clone build based on upstream version ${{ steps.check.outputs.release_tag }}.
            Package Name: `com.metrolist.clone`
            App Name: `Metrolist Neo`
            Note: Custom Round Icon & Renamed.
          files: output_apks/*-signed.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
